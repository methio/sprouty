<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>My Awesome App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />

    <link rel="stylesheet" type="text/css" href="/stylesheets/style.css" />
    <link rel="stylesheet" type="text/css" href="/stylesheets/plants.css" />

    <style>
      .status-label,
      .water-value,
      .light-value,
      .temp-value {
        display: none !important;
      }
      .status-bars {
        display: flex;
        flex-direction: column;
        gap: 12px;
        width: 100%;
        margin-top: 12px;
      }
      .status-bar { width: 100%; }
      .status-svgbar {
        display: block;
        width: 100%;
        max-width: 360px;
        height: auto;
      }
    </style>
  </head>

  <body>
    <div id="container">
      <div class="header flex row space-between align-center">
        <a href="/plants" class="back-button">Back to Shelves</a>
        <div class="coins"> sproot: {{user.money}}</div>
      </div>

      <div class="plant-details">

        <div class="plant-image" style="position: relative;">
          
          
          {{#if plant.pot}}
            <img src="{{plant.pot}}" class="plant-pot"/>
          {{/if}}
        
          <img src="/{{plant.plant_url}}" alt="{{plant.plant_family}}" width="150"/>
          
        </div>

        <h1>{{#if plant.name}}{{plant.name}}{{else}}{{plant.plant_family}}{{/if}}</h1>


        <div class="plant-actions flex row gap-1" style="position: relative;">
          <button class="inventory-btn" id="inventory-btn" type="button">Inventory</button>
          <div class="pop-up" id="inventory-popup" style="display:none;"></div>
        </div>


        <div class="status-bars">
          <div class="status-bar">
            <img id="water-bar-img" class="status-svgbar"
              src="/assets/status%20bar/water_{{plant.water_level}}.svg" alt="Water bar" />
          </div>

          <div class="status-bar">
            <img id="light-bar-img" class="status-svgbar"
              src="/assets/status%20bar/light_{{plant.light_level}}.svg" alt="Light bar" />
          </div>

          <div class="status-bar">
            <img id="temp-bar-img" class="status-svgbar"
              src="/assets/status%20bar/temp_{{plant.temp_level}}.svg" alt="Temperature bar" />
          </div>
        </div>

        <div class="plant-actions flex row gap-1" style="position: relative;">
          <button class="action-btn" id="water-btn" type="button">Water Plant <br>click for more</button>

          <div class="pop-up" id="low-water-popup" style="display:none;"></div>
          <div class="pop-up" id="thank-you-popup" style="display:none;"></div>
        </div>


      </div>

      {{> menu}}
    </div>

    <script>
      const plantData = {{{json plant}}};
      const userData = {{{json user}}};

      const ADAFRUIT_USERNAME = 'arianna2345';
      const ADAFRUIT_KEY = 'aio_ZsIU98Kpvmqfe3D4aT6RtmKd5x7J';

      const FEEDS = {
        water: 'soil-moisture',
        light: 'light',
        temp: 'temperature'
      };

      const STATUS_ICON_BASE = '/assets/status%20bar';


      //water me popup
      const lowWaterPopup = document.getElementById('low-water-popup');
      const waterBtn = document.getElementById('water-btn');
      
      const lowWaterPopupData = `
        <h3>Water me!</h3>
        <p>Take the watering cup and pour water into the pot.</p>
        <p>(The alert will disappear after you water the plant)</p>
        <button id="close-low-water-popup">Got it</button>
      `;


      //reward popup
      const thankYouPopup = document.getElementById('thank-you-popup');
      const thankYouPopupData = `
        <h3>Thank you for watering me!</h3>
        <p>
          +10 <img src="/assets/menu/leaf_currency.svg" alt="+10" width="20">
        </p>
        <button id="close-thank-you-popup">Got it</button>
      `;


      function clampLevel(value, scale = 5) {
        const n = Number(value);
        if (!Number.isFinite(n)) return 1;
        return Math.min(scale, Math.max(1, Math.round(n)));
      }

      function setBarImg(id, src) {
        const el = document.getElementById(id);
        if (el) el.src = src;
      }

      // thresholds -> 1..5
      function mapSoilMoistureToLevel(raw) {
        const v = Number(raw);
        if (!Number.isFinite(v)) return 1;
        if (v < 300) return 1;
        if (v < 450) return 2;
        if (v < 650) return 3;
        if (v < 850) return 4;
        return 5;
      }

      function mapLightToLevel(raw) {
        const v = Number(raw);
        if (!Number.isFinite(v)) return 1;
        if (v < 500)  return 1;
        if (v < 1500) return 2;
        if (v < 3000) return 3;
        if (v < 4500) return 4;
        return 5;
      }

      function mapTempToLevel(raw) {
        const v = Number(raw);
        if (!Number.isFinite(v)) return 1;
        if (v < 15) return 1;
        if (v < 18) return 2;
        if (v < 24) return 3;
        if (v < 28) return 4;
        return 5;
      }

      function updatePlantStatus(waterLevel, lightLevel, tempLevel) {
        const levelScale = Number(plantData.level_scale) || 5;

        waterLevel = clampLevel(waterLevel, levelScale);
        lightLevel = clampLevel(lightLevel, levelScale);
        tempLevel  = clampLevel(tempLevel, levelScale);

        setBarImg('water-bar-img', `${STATUS_ICON_BASE}/water_${waterLevel}.svg`);
        setBarImg('light-bar-img', `${STATUS_ICON_BASE}/light_${lightLevel}.svg`);
        setBarImg('temp-bar-img',  `${STATUS_ICON_BASE}/temp_${tempLevel}.svg`);


        //water me + reward popups
        if (lowWaterPopup) {
          if (waterLevel <= 3) {
            lowWaterPopup.innerHTML = lowWaterPopupData;
            waterBtn.style.display = 'inline-block';

            if (waterLevel <=3 && plantData.reward_given === true){
              plantData.reward_given = false;
            }
            
          } else {
            lowWaterPopup.style.display = 'none';
            waterBtn.style.display = 'none';
            
            if (
              waterLevel > 3 &&
              plantData.reward_given === false &&
              plantData.water_level <=3
            ) {
              thankYouPopup.innerHTML = thankYouPopupData;
              thankYouPopup.style.display = 'block';

              reward();

              plantData.reward_given = true;

              fetch(`/plants/${plantData.plant_id}/update-levels`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  water_level: waterLevel,
                  light_level: plantData.light_level,
                  temp_level: plantData.temp_level,
                  reward_given: true
                })
              });
            

              setTimeout(() => {
                thankYouPopup.style.display = 'none';
              }, 15000);
            }
          }
        }

        plantData.water_level = waterLevel;
        plantData.light_level = lightLevel;
        plantData.temp_level  = tempLevel;
      }

      updatePlantStatus(plantData.water_level, plantData.light_level, plantData.temp_level);

      if (lowWaterPopup) {
        lowWaterPopup.onclick = (event) => {
          if (event.target.id === 'close-low-water-popup') lowWaterPopup.style.display = 'none';
        };
      }

      if (thankYouPopup){
        thankYouPopup.onclick = (event) => {
          if (event.target.id === 'close-thank-you-popup'){
            thankYouPopup.style.display = 'none';
          }
        };
      }

      if (waterBtn) {
        waterBtn.addEventListener('click', () => {
          if (plantData.water_level <= 3) lowWaterPopup.style.display = 'block';
        });
      }




      async function updatePlantInDatabase(waterLevel, lightLevel, tempLevel) {
        try {
          const response = await fetch(`/plants/${plantData.plant_id}/update-levels`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              water_level: waterLevel,
              light_level: lightLevel,
              temp_level: tempLevel
            })
          });
        } catch (error) {
          console.error('[DB] Error updating plant:', error);
        }
      }

      async function fetchSensorData() {
        try {
          const headers = { 'X-AIO-Key': ADAFRUIT_KEY };

          const [waterRes, lightRes, tempRes] = await Promise.all([
            fetch(`https://io.adafruit.com/api/v2/${ADAFRUIT_USERNAME}/feeds/${FEEDS.water}/data/last`, { headers }),
            fetch(`https://io.adafruit.com/api/v2/${ADAFRUIT_USERNAME}/feeds/${FEEDS.light}/data/last`, { headers }),
            fetch(`https://io.adafruit.com/api/v2/${ADAFRUIT_USERNAME}/feeds/${FEEDS.temp}/data/last`, { headers })
          ]);

          if (!waterRes.ok || !lightRes.ok || !tempRes.ok) return;

          const [waterData, lightData, tempData] = await Promise.all([
            waterRes.json(),
            lightRes.json(),
            tempRes.json()
          ]);

          const waterLevel = mapSoilMoistureToLevel(waterData.value);
          const lightLevel = mapLightToLevel(lightData.value);
          const tempLevel  = mapTempToLevel(tempData.value);

          updatePlantStatus(waterLevel, lightLevel, tempLevel);
          updatePlantInDatabase(waterLevel, lightLevel, tempLevel);
        } catch (error) {
          console.error('[Adafruit] Error:', error);
        }
      }

      const IS_STUART = Number(plantData.sensor_number) === 1 && String(plantData.name).toLowerCase() === 'stuart';

      if (IS_STUART) {
        console.log('[Sensors] Live updates ENABLED for Stuart');
        fetchSensorData();
        setInterval(fetchSensorData, 15000);
      } else {
        console.log('[Sensors] Live updates DISABLED for this plant:', plantData.name);
      }


      async function reward() {
        try {
          const response = await fetch('/plants/user/reward-watering', {
            method: 'POST'
          });

          if (!response.ok) {
            console.error('Reward failed');
            return;
          }

          const data = await response.json();

          // update coins UI
          const coinsEl = document.querySelector('.coins');
          if (coinsEl) {
            coinsEl.textContent = `sproot: ${data.money}`;
          }
        } catch (error) {
          console.error('Error rewarding user:', error);
        }
      }


    const inventoryPopup = document.getElementById('inventory-popup');
    const inventoryBtn = document.getElementById('inventory-btn');

    function renderInventory() {
      if (!userData.inventory || userData.inventory.length === 0) {
        inventoryPopup.innerHTML = `
          <h3>Inventory</h3>
          <p>No items yet</p>
          <button id="close-inventory">Close</button>
        `;
        return;
      }

      inventoryPopup.innerHTML = `
        <h3>Inventory</h3>
        <div class="inventory-items">
          ${userData.inventory.map((item, index) => `
            <div class="inventory-item">
              <img src="${item.item_url}" width="60" />
              <p>${item.item}</p>
              <button data-index="${index}" class="equip-btn">Equip</button>
            </div>
          `).join('')}
        </div>
        <button id="close-inventory">Close</button>
      `;
    }


    if (inventoryBtn) {
      inventoryBtn.addEventListener('click', () => {
        renderInventory();
        inventoryPopup.style.display = 'block';
      });
    }

    inventoryPopup.onclick = async (event) => {
      if (event.target.id === 'close-inventory') {
        inventoryPopup.style.display = 'none';
      }

      if (event.target.classList.contains('equip-btn')) {
        const index = event.target.dataset.index;

        await fetch(`/plants/${plantData.plant_id}/equip`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ inventoryIndex: index })
        });

        location.reload(); // simplest + matches your style
      }
    };




    </script>
  </body>
</html>
